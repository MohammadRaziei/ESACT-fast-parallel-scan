<!DOCTYPE html>
<html>

<head>
    <script src="https://d3js.org/d3.v6.min.js"></script>

    
    <!-- <script> -->
        <!-- // MathJax = { -->
        <!-- //   loader: {load: ['input/asciimath', 'output/chtml']} -->
        <!-- // } -->
        <!-- // </script> -->
        <!-- <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> -->
        <!-- <script type="text/javascript" id="MathJax-script" async -->
          <!-- src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/startup.js"> -->
        <!-- </script> -->

</head>

<body>

    <h3>Graph creator</h3>
    <p>Please input the power of two.</p>

    <input id="myInput" value="8" type="number">
    <!-- <button id="myBtn" onclick="">Button</button> -->

    <br />
    <br />


    <svg id="canvas"></svg>


    <script>
        var svg = d3.select("svg#canvas");

        // https://www.w3.org/TR/SVG11/types.html#ColorKeywords

        // Node component representing a rectangle
        class Node {
            static width = 100;
            static height = 50;

            constructor(x, y, colorfill = "powderblue", text = "") {
                this.x = x;
                this.y = y;
                this.colorfill = colorfill;
                this.width = Node.width;
                this.height = Node.height;
                this.text = text;
            }

            draw() {
                this.elem = svg.append("rect")
                    .attr("x", this.x)
                    .attr("y", this.y)
                    .attr("width", this.width)
                    .attr("height", this.height)
                    .attr("stroke", "black")
                    .attr("fill", this.colorfill);

                this.addText(this.text);

                // Return self for method chaining
                return this;
            }

            addText(text){
                if (text !== "") {
                    svg.append("text")
                        .attr("x", this.x + this.width / 2)
                        .attr("y", this.y + this.height / 2)
                        .attr("text-anchor", "middle")
                        .attr("dominant-baseline", "central")
                        // .attr("style", "position: absolute; z-index: 10;")
                        .text(text);
                }
            }


            getBottomCenter() {
                return { x: this.x + this.width / 2, y: this.y + this.height };
            }

            getTopCenter() {
                return { x: this.x + this.width / 2, y: this.y };
            }
        }

        // Arrow component to draw an arrow between two nodes
        class Arrow{
            constructor(fromNode, toNode, color="black") {
                
            
            this.draw = function () {
                var start = fromNode.getBottomCenter();
                var end = toNode.getTopCenter();

                const calcX = (n1, n2) => {
                    const tmp = .95 * n1.x + .05 * n2.x;
                    return Math.max(Math.min(tmp, n1.x + Node.width * .3), n1.x - Node.width * .3);
                };
                svg.append("line")
                    .attr("x1", calcX(start, end))
                    .attr("y1", start.y)
                    .attr("x2", calcX(end, start))
                    .attr("y2", end.y - 1)
                    .attr("stroke", color)
                    .attr("stroke-width", 2)
                    .attr("marker-end", "url(#arrow)");
            }
        }
    }

        function create_svg(number_nodes) {
            svg.selectAll("*").remove();


            const number_of_steps = Math.floor(Math.log2(number_nodes) + 1) * 2
            const totalwidth = (Node.width + 1) * number_nodes;
            const totalheight = (Node.height * 2) * number_of_steps;


            svg.style("width", totalwidth + 'px')
                .style("height", totalheight + 'px');

            // Create the arrow marker definition
            svg.append("svg:defs").append("svg:marker")
                .attr("id", "arrow")
                .attr("viewBox", "0 -5 10 10")
                .attr("refX", 8) // Adjust the refX to offset the arrow to align properly
                .attr("refY", 0)
                .attr("markerWidth", 4)
                .attr("markerHeight", 4)
                .attr("orient", "auto")
                .append("svg:path")
                .attr("d", "M0,-5L10,0L0,5")
                .attr("fill", "black");

            // Create two instances of the Node component
            var nodes = Array.from({ length: number_of_steps }, (_, col) =>
                Array.from({ length: number_nodes }, (_, row) =>
                    new Node(row * (Node.width), col * (Node.height * 2)).draw()
                )
            );
            // var node1 = new Node(150, 50).draw();

            // Create an instance of the Arrow component to connect node1 and node2

            let row = 0

            for (let i = 0; i < number_nodes; i++) {
                nodes[row][i].addText("X" + i + "");
            }
                
            for (let s = 2; s <= number_nodes; s <<= 1) {
                for (let i = 0; i < number_nodes / s; i++) {
                    new Arrow(nodes[row][s * i + Math.floor(s/2) - 1], nodes[row + 1][s * i + s - 1]).draw();
                    new Arrow(nodes[row][s * i + s - 1], nodes[row + 1][s * i + s - 1]).draw();
                }
                row++;
            }
            new Arrow(nodes[row][number_nodes-1], nodes[++row][number_nodes-1], "red").draw();

            for (let s = number_nodes; s > 1; s >>= 1) {
                for (let i = 0; i < number_nodes / s; i++) {
                    new Arrow(nodes[row][s * i + Math.floor(s/2) - 1], nodes[row + 1][s * i + s - 1]).draw();
                    new Arrow(nodes[row][s * i + s - 1], nodes[row + 1][s * i + s - 1]).draw();
                    new Arrow(nodes[row][s * i + s - 1], nodes[row + 1][s * i + Math.floor(s/2) - 1]).draw();
                }
                row++;
            }
        }

        var input = document.getElementById("myInput");
        input.addEventListener("keypress", function (event) {
            if (event.key === "Enter") {
                event.preventDefault();
                const number_nodes = parseInt(input.value);
                create_svg(number_nodes);
            }
        });
        const number_nodes = parseInt(input.value);
        create_svg(number_nodes);

    </script>
</body>

</html>